<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <!-- The above 3 meta tags *must* come first in the head; any other head content must come *after* these tags -->
    <meta name="description" content="">
    <meta name="author" content="">
    <link rel="icon" href="../../favicon.ico">

    <title>Tornado: A Distributed Spatio-Textual Data Stream Processing System</title>

    <!-- Bootstrap core CSS -->
    <link href="css/bootstrap.min.css" rel="stylesheet">

    <!-- Custom styles for this template -->
    <link href="css/starter-template.css" rel="stylesheet">

    <!-- Just for debugging purposes. Don't actually copy these 2 lines! -->
    <!--[if lt IE 9]><script src="../../assets/js/ie8-responsive-file-warning.js"></script><![endif]-->
    <script src="js/ie-emulation-modes-warning.js"></script>

    <!-- HTML5 shim and Respond.js for IE8 support of HTML5 elements and media queries -->
    <!--[if lt IE 9]>
      <script src="https://oss.maxcdn.com/html5shiv/3.7.2/html5shiv.min.js"></script>
      <script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
    <![endif]-->

    <script src="cm/lib/codemirror.js"></script>
    <link rel="stylesheet" href="cm/lib/codemirror.css">
    <script src="cm/mode/sql/sql.js"></script>
    <link rel="stylesheet" href="cm/addon/hint/show-hint.css" />
    <script src="cm/addon/hint/show-hint.js"></script>
    <script src="cm/addon/hint/sql-hint.js"></script>


    <link type="text/css" rel="stylesheet" href="css/jquery-ui.min.css">
    <!-- <link type="text/css" rel="stylesheet" href="css/vis.css"> -->
    <link type="text/css" rel="stylesheet" href="css/mapui.css">

    <script type="text/javascript" src="js/jquery.js"></script>
    <script type="text/javascript" src="js/jquery.json.min.js"></script>
    <script type="text/javascript" src="js/jquery-ui.min.js"></script>
    <script type="text/javascript" src="js/portal.min.js"></script>
    <script type="text/javascript" src="js/randomColor.js"></script>
    <script src="js/peg-0.8.0.min.js"></script>
    <script src="js/jsDump.js" ></script>
    <script type="text/javascript" src="js/vis.js"></script>
    


    <script type="text/javascript" src="https://maps.googleapis.com/maps/api/js?key=AIzaSyDUTsGEgrknzPi1xdS1NxH5quGucPmpZoA&v=3.exp&libraries=drawing,geometry,places"></script>

    
  </head>

  <body>
    <div class="container-fluid">
    <nav class="navbar navbar-inverse navbar-fixed-top">
      <div class="container-fluid">
        <div class="navbar-header">
          <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false" aria-controls="navbar">
            <span class="sr-only">Toggle navigation</span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
          </button>
          <a class="navbar-brand" href="#">Tornado UI</a>
        </div>
        <div id="navbar" class="collapse navbar-collapse">
          <ul class="nav navbar-nav">
            <li><a href="#syslogpanel" data-toggle="collapse" aria-expanded="false" aria-controls="syslogpanel">Session Log</a></li>
            <li><a href="#regQD" data-toggle="collapse" aria-expanded="false" aria-controls="regQD">Registered Queries and Data Sources</a></li>
            <li><a href="#queryParams" data-toggle="collapse" aria-expanded="false" aria-controls="queryParams">Query Parameters</a></li>
            <li><a href="#queryInput" data-toggle="collapse" aria-expanded="false" aria-controls="queryInput">Query Input</a></li>
            <li><a href="#adaptiveindex">Adaptive Index</a></li>
          </ul>
        </div><!--/.nav-collapse -->
      </div>
    </nav>
      <div class="row">
            <div class"panel panel-info collapse" id="syslogpanel">
              <div class="panel-heading">
                <h3 class="panel-title">Session Log</h3>
              </div>
              <div class="panel-body" id="syslog">                
              </div>
            </div>
            <div class="collapse" id="regQD">
              <div id="regQueries" class="col-md-6">
                <h5 >Registered Queries</h5>
                <ul class="list-group" id="regQueriesList">
                  <li class="list-group-item empty">No registered continuous queries
                  </li>
                </ul>
              </div>
              <div id="regDatasources" class="col-md-6">
                <h5 >Registered Data Sources</h5>
                <ul class="list-group">
                  <li class="list-group-item">No registered Data sources</li>
                </ul>
              </div>
            </div>
            <div id="queryParams" class="collapse" >
              <div class="predicateList col-md-6">
                  <h5>Focal points</h5>
                  <ul id="knnList" class="list-group">
                      <li class="list-group-item"> No points</li>
                  </ul>
              </div>
              <div class="predicateList col-md-6">
                  <h5>Range predicates</h5>
                  <ul id="rangeList" class="list-group">
                      <li class="list-group-item">No predicates</li>
                  </ul>
              </div>
            </div>
            <div id="queryInput" class="col-md-12 collapse in">
              <div >
                <div id="textEntry" class="col-md-10">
                <textarea id="textData" >REGISTER QUERY q1 AS
SELECT * FROM OSM_Data AS O, Tweets AS T
WHERE WITHIN_DISTANCE(O.loc,T.loc,1)
and CONTAINS(O.tags,"attraction")
and INSIDE(T.loc,currentView)
and OVERLAPS(O.tags, T.text);</textarea>
              </div>    
            <div id="buttonPanel" role="group" class="btn-group-vertical col-md-2">
                  <button id="compileSQL" class="btn btn-primary btn-sm">Parse</button>  
                  <button id="submitSQL" class="btn btn-default btn-sm">Submit</button>  

              </div>  
              </div>
            </div>
      </div>
      <div class="row">
        <div  class="panel panel-default col-md-3">
  <!--         <div class="panel-heading">
             <h3 class="panel-title">Text output</h3>

          </div> -->
          <div class="panel-body" id="tweetsList">
            <p>No output</p>
          </div>

        </div>
         <div  class="panel panel-default col-md-9">
            <!-- <div class="panel-heading">
              <h3 class="panel-title">Map-based Interface</h3>
            </div> -->
            <!-- <div class="panel-body"> -->
              <div id="map-canvas" class="table" ></div>
            <!-- </div> -->
         </div>
      </div>

      <div class="hidden row">
      <div class="panel panel-default">
        <div class="panel-body" >
          
        
            


          <div id="dialog-ast" class="hidden col-md-12" title="Parse Tree">
              <div id="prettyPrint" class="jsDump"></div> 

          </div>

          <div id="visholder" class="hidden col-md-12"></div>  
        </div>
      </div>
      </div>

    </div> <!-- /.container -->
    <div class="hidden">

        <div id="SyncSQLGrammar" style="display:none;">
              /*
* Grammar for parsing SyncSQL
* Currently Implemented:
*  - Register Source Statement
Example:  
register source s2 (JsString rid, JsNumber RoomTemp, JsString RoomNotes, JsNumber phoneNumber);

*  - Select Statement
*     - With Project -
Example:
create streamed view q1 as 
select * 
from s1 as stream1 sync 3,s2
where s1.rid = "r1" and s2.roomTemp = 3;

* - Spatial Predicates inRange and kNN

*/

{
//var uiState = {
//resolveRangePredVar: function(){return null;},
//resolveKNNPredVar:function(){return null;}
//};

   function getState(){
      return uiState;
   }

   function bindVar(t, v){
      //console.log(uiState);
     if (t == "kNN"){
      console.log(uiState.resolveKNNPredVar(v));
      return uiState.resolveKNNPredVar(v);
     } 
     else if (t == "inRange"){        
        return uiState.resolveRangePredVar(v);
     }
     else return null;
   }   

}

start = sqls:sqlstmt spp ";" sps {return sqls}
sqlstmt = regstmt / createviewstmt 

createviewstmt = t:(("CREATE" spp "STREAMED") / ("REGISTER" / "register") / ("RUN" / "run")) spp ("VIEW" / ("QUERY" / "query")) spp cn:ident spp as spp sel:selectstmt {var res = {};

if (t === "register" || t === "REGISTER") res.type = "cquery";
if (t === "run" || t === "RUN") res.type = "squery";

res.name=cn; 
//res.pl = sel.pl; res.fc = sel.fc; res.wc = sel.wc;

res.sourceNames = [];
for (i in sel.fc){ if ($.inArray(sel.fc[i].name,res.sourceNames) === -1 ) res.sourceNames.push(sel.fc[i].name); }
res.plan = {};
var child;
if (sel.fc.length == 1){
if (sel.wc != null){

child = {"type":"select","conditions":sel.wc.conditions};
child.children = [sel.fc.pop()];
}
else{
child = sel.fc[0]
}
sel.pl.children = [child]
   res.plan =sel.pl;
}
else{

if (sel.wc != null){


// sel.fc.length == 2
var leftleaf = sel.fc.pop();
var rightleaf = sel.fc.pop();
var left = leftleaf;
var right = rightleaf;

var jconds = [];

var i = sel.wc.conditions.length-1;
while (sel.wc.conditions.length && i >= 0){
//console.log(sel.wc.conditions);
var sn = sel.wc.conditions[i].lhs.sourceName;
var cleft = sel.wc.conditions[i].lhs;
var cright = sel.wc.conditions[i].rhs;
if ($.isPlainObject(cleft) && $.isPlainObject(cright)){

// a join condition
var jcond = sel.wc.conditions.splice(i,1);
jconds.push(jcond[0]);
}
else if (sn === left.name ||  sn === left.alias){
  
   var leftselect = {};
   leftselect.type = "select";
   //leftselect.name = sn;
   leftselect.conditions = sel.wc.conditions.splice(i,1);
   leftselect.children=[left];
   left = leftselect;
 }
else if (sn === right.name || sn === right.alias){
   //alert(sn);
   var rightselect = {};
   rightselect.type = "select";
   //rightselect.name = sn;
   rightselect.conditions = sel.wc.conditions.splice(i,1);
   rightselect.children=[right];
   right = rightselect;
}
else if (right.type === "select"){
  right.conditions.push(sel.wc.conditions.splice(i,1)[0]);
}
else if (left.type === "select"){
  left.conditions.push(sel.wc.conditions.splice(i,1)[0]);
}
--i;
   
}
var join = {"type":"join","conditions":jconds,"children":[left,right]};

   sel.pl.children = [join]
   res.plan =sel.pl;
}
}

return res;}

/****** BEGIN Select Statement *****/

selectstmt = ("select" / "SELECT") spp pl:projectList spp fc:fromclause wc:(spp whereclause)?
{var res = {};
res.pl = pl;
res.fc = fc;
res.plan = {};
if (wc != null){
res.wc = wc[1];
}
return res;}

projectList = pa:"*" {return {"type":"project","attributes":[pa]}}

fromclause = ("from" / "FROM") sp sl:sourceList {return sl;}

sourceList = s1:sourceName sps sl:(comma sps sourceList)? 
{var res = []; 
res.push(s1); if (sl != null) for (i in sl[2]) res.push(sl[2][i]); return res;}

sourceName = n:ident  a:(sps as sp ident)? sps sync:(sps "sync" sp numVal)? {
var res = {};
res.type = "source";//"stream";
res.name = n
if (a != null) res.alias = a[3];
if (sync != null) res.sync = sync[3];
return res;}

whereclause = ("where" / "WHERE") spp cl:condList {return {"conditions":cl};}

condList = c1:scondition sps cl:("and" sp condList)? {var res = []; res.push(c1); if (cl != null){
for (i in cl[2]) res.push(cl[2][i]);
}; return res;}

scondition = lhs:cident sp cop:coper sp rhs:cident 
{return [lhs,cop,rhs];}
/ lhs:cident sp cop:coper sp rhs:numVal 
{return [lhs,cop,rhs];}
/ lhs:cident sp cop:coper sp rhs:strVal 
{return [lhs,cop,rhs];}
/ obj:ident sps dot sps pname:predName1 sps op sps parg:ident  sps cp 
{return [obj,pname,bindVar(pname,parg)];}
/ obj:ident sps dot sps pname:predName2n sps op sps kval:numVal sps comma sps parg:ident  sps cp {return [obj,pname,kval,bindVar(pname,parg)];}
/ pname:(func2p) sps op sps obj:cident sps comma sps parg:ident sps cp 
{return {argc:2,jcond:false,op:pname,lhs:obj,rhs:bindVar(pname,parg)};}
/ pname:(func2p) sps op sps obj:cident sps comma sps parg:cident sps cp 
{return {argc:2,jcond:true,op:pname,lhs:obj,rhs:parg};}
/ pname:(func2p) sps op sps obj:cident sps comma sps parg:strVal sps cp 
{return {argc:2,jcond:false,op:pname,lhs:obj,rhs:parg[1]};}
/ pname:(func3p) sps op sps obj1:cident sps comma sps obj2:cident sps comma sps parg:numVal sps cp 
{return {argc:3,jcond:true,op:pname,lhs:obj1,rhs:obj2,cval:parg};}



cident = sa:(ident ".")? ca:ident { if (sa != null) return {"sourceName":sa[0],"attributeName":ca}; else return {"attributeName":ca};}

coper = "=" / ">" / "<" / ">=" / "<=" / "!="

as = "as" / "AS"

/****** END Select Statement *****/

/****** BEGIN  Register Source Statement *****/
regstmt = "register" sp "source" sp id:ident sp op sps schema:attrList sps cp {return {"type":"sources","id":id,"schema":schema}}

attrList = a1:attribute sps comma sps an:attrList 
{var res = []; res.push(a1); 
for (i in an) res.push(an[i]);
return res;}
           / a:attribute {var res =[]; res.push(a);return res;}
attribute = dt:data_type sps attrName:ident sps k:isKey?
{
var res = new Object(); 
res = {"name":attrName,"type":dt};
if (k != null) res["isKey"] = (k!=null);
return res;
}
isKey = "key"

/****** END Register Source Statement *****/


numVal = dig:[0-9]+ {return new Number(dig.join("")).valueOf();}
strVal = "\"" str:ident "\"" / "'" str:ident "'" {return str;}


ident = alpha:[a-zA-Z_]+dig:[0-9]* {return alpha.join("").concat(dig.join(""));}
data_type = "JsNumber" / "JsString" / "JsBoolean" 

//omem = rel:ident sps dot sps attr:ident { return {"sourceName":rel,"attrName":attr}}

predName1 = 
"inRange" 

predName2n = 
"kNN"

func1p = "1p"

func2p = "INSIDE" / "CONTAINS" / "OVERLAPS"

func3p = "WITHIN_DISTANCE"

and = "and"/ "AND"
or = "or" / "OR"

comma = ","
dot = "."

cp = ")"

op = "("

nl = "\n"
nls = nl*
sps = sp* nls
spp = sps nl? sps
sp = " "
        </div>

    </div>
    <!-- Bootstrap core JavaScript
    ================================================== -->
    <!-- Placed at the end of the document so the pages load faster 
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.2/jquery.min.js"></script>
    -->
    <script src="js/bootstrap.min.js"></script>
    <!-- IE10 viewport hack for Surface/desktop Windows 8 bug -->
    <script src="js/ie10-viewport-bug-workaround.js"></script>

    <script type="text/javascript" src="js/mapui.js"></script>
  </body>
</html>
